# ASP.NET
# Build and test ASP.NET projects.
# Add steps that publish symbols, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/apps/aspnet/build-aspnet-4

# trigger:
# - master

pool:
  name: 'Requiem Labs'

variables:
  solution: '**/*.sln'
  buildPlatform: 'Any CPU'
  buildConfiguration: 'Release'
  major: 0
  minor: 1
  patch: 1

stages:
- stage: BMVN
  displayName: Build Master Version Number
#  condition: eq(variables['Build.SourceBranch'], 'refs/heads/master')
  jobs:
  - job: BMVN
    displayName: Build Master Version Number
    variables:
       buildnum: $[counter(variables['patch'], 0)]
       fullbuildnum: $(MAJOR).$(MINOR).$(PATCH).$(BUILDNUM)
    steps:
      - powershell: |
           echo "##vso[build.updatebuildnumber]$(MAJOR).$(MINOR).$(PATCH).$(BUILDNUM)"
        name: SMBN
        displayName: Set Master Build Name

- stage: Test_Build_App_Version
  displayName: Test Stage - Versioning
  jobs:
  - job: Build_App
    steps:
    - task: PowerShell@2
      inputs:
        targetType: 'inline'
        script: 'Write-Host "Build is $(Build.BuildNumber)"'
        errorActionPreference: 'continue'
    - task: Assembly-Info-NetCore@2
      inputs:
        Path: '$(Build.SourcesDirectory)'
        FileNames: '**/*.csproj'
        InsertAttributes: true
        FileEncoding: 'auto'
        WriteBOM: false
        Authors: 'Requiem Labs'
        Company: 'Requiem Labs'
        VersionNumber: '$(Build.BuildNumber)'
        FileVersionNumber: '$(Build.BuildNumber)'
        InformationalVersion: '$(Build.BuildNumber)'
        LogLevel: 'verbose'
        FailOnWarning: false
        DisableTelemetry: false
    - task: DotNetCoreCLI@2
      inputs:
        command: 'build'
        projects: '**/Labmin.Api.csproj'


